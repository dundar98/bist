# GitHub Actions Workflow: BIST100 Daily Signal Scanner
# Her gÃ¼n TÃ¼rkiye saati 09:00'da Ã§alÄ±ÅŸÄ±r ve e-posta gÃ¶nderir

name: BIST100 Daily Scan

on:
  # Her gÃ¼n 06:00 UTC = 09:00 TÃ¼rkiye saati
  schedule:
    # Run at 10:30, 13:00, 16:00 TRT (UTC+3)
    # UTC: 07:30, 10:00, 13:00
    - cron: '30 7,10,13 * * 1-5'
  
  # Manuel Ã§alÄ±ÅŸtÄ±rma iÃ§in
  workflow_dispatch:
    inputs:
      send_email:
        description: 'E-posta gÃ¶nder'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  PYTHON_VERSION: '3.11'

permissions:
  contents: write

jobs:
  daily-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸ§¹ Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          df -h
      
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt --no-cache-dir
      
      - name: ðŸ§  Check for trained model
        id: check_model
        run: |
          if [ -f "output/model.pt" ]; then
            echo "model_exists=true" >> $GITHUB_OUTPUT
          else
            echo "model_exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ‹ï¸ Train model (if not exists)
        if: steps.check_model.outputs.model_exists == 'false'
        run: |
          python scripts/run_pipeline.py --mode demo --epochs 20
      
      - name: ðŸ“Š Run daily scan
        env:
          BIST_EMAIL_SENDER: ${{ secrets.BIST_EMAIL_SENDER }}
          BIST_EMAIL_PASSWORD: ${{ secrets.BIST_EMAIL_PASSWORD }}
          BIST_EMAIL_RECIPIENTS: ${{ secrets.BIST_EMAIL_RECIPIENTS }}
        run: |
          # Determine args
          EMAIL_FLAG=""
          if [ "${{ github.event.inputs.send_email || 'true' }}" = "true" ]; then
            EMAIL_FLAG="--email"
          fi
          
          echo "ðŸš€ Starting Daily Scan..."
          echo "Email Flag: $EMAIL_FLAG"
          
          # Run python script (let it handle credential validation)
          python scripts/run_daily_scan.py \
            $EMAIL_FLAG \
            --sender-email "$BIST_EMAIL_SENDER" \
            --sender-password "$BIST_EMAIL_PASSWORD" \
            --email-to "$BIST_EMAIL_RECIPIENTS" \
            --data-source yfinance \
            --output-dir output/scans
      
      - name: ðŸ“ Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: scan-results-${{ github.run_id }}
          path: output/scans/
          retention-days: 30
      
      - name: ðŸš€ Commit dashboard updates
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # Add dashboard data
          git add docs/dashboard_data.json
          
          # Commit if changes exist
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update dashboard data [skip ci]" && git push)
      
      - name: ðŸ“ Summary
        run: |
          echo "## ðŸ“Š BIST100 GÃ¼nlÃ¼k Tarama TamamlandÄ±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tarih:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **E-posta:** ${{ github.event.inputs.send_email || 'true' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "output/scans/scan_$(date '+%Y-%m-%d').txt" ]; then
            echo "### Rapor Ã–zeti" >> $GITHUB_STEP_SUMMARY
            head -30 "output/scans/scan_$(date '+%Y-%m-%d').txt" >> $GITHUB_STEP_SUMMARY
          fi
